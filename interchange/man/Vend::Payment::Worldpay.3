.\" Automatically generated by Pod::Man 2.28 (Pod::Simple 3.29)
.\"
.\" Standard preamble:
.\" ========================================================================
.de Sp \" Vertical space (when we can't use .PP)
.if t .sp .5v
.if n .sp
..
.de Vb \" Begin verbatim text
.ft CW
.nf
.ne \\$1
..
.de Ve \" End verbatim text
.ft R
.fi
..
.\" Set up some character translations and predefined strings.  \*(-- will
.\" give an unbreakable dash, \*(PI will give pi, \*(L" will give a left
.\" double quote, and \*(R" will give a right double quote.  \*(C+ will
.\" give a nicer C++.  Capital omega is used to do unbreakable dashes and
.\" therefore won't be available.  \*(C` and \*(C' expand to `' in nroff,
.\" nothing in troff, for use with C<>.
.tr \(*W-
.ds C+ C\v'-.1v'\h'-1p'\s-2+\h'-1p'+\s0\v'.1v'\h'-1p'
.ie n \{\
.    ds -- \(*W-
.    ds PI pi
.    if (\n(.H=4u)&(1m=24u) .ds -- \(*W\h'-12u'\(*W\h'-12u'-\" diablo 10 pitch
.    if (\n(.H=4u)&(1m=20u) .ds -- \(*W\h'-12u'\(*W\h'-8u'-\"  diablo 12 pitch
.    ds L" ""
.    ds R" ""
.    ds C` ""
.    ds C' ""
'br\}
.el\{\
.    ds -- \|\(em\|
.    ds PI \(*p
.    ds L" ``
.    ds R" ''
.    ds C`
.    ds C'
'br\}
.\"
.\" Escape single quotes in literal strings from groff's Unicode transform.
.ie \n(.g .ds Aq \(aq
.el       .ds Aq '
.\"
.\" If the F register is turned on, we'll generate index entries on stderr for
.\" titles (.TH), headers (.SH), subsections (.SS), items (.Ip), and index
.\" entries marked with X<> in POD.  Of course, you'll have to process the
.\" output yourself in some meaningful fashion.
.\"
.\" Avoid warning from groff about undefined register 'F'.
.de IX
..
.nr rF 0
.if \n(.g .if rF .nr rF 1
.if (\n(rF:(\n(.g==0)) \{
.    if \nF \{
.        de IX
.        tm Index:\\$1\t\\n%\t"\\$2"
..
.        if !\nF==2 \{
.            nr % 0
.            nr F 2
.        \}
.    \}
.\}
.rr rF
.\" ========================================================================
.\"
.IX Title "Vend::Payment::Worldpay 3"
.TH Vend::Payment::Worldpay 3 "2016-12-23" "perl v5.22.2" "User Contributed Perl Documentation"
.\" For nroff, turn off justification.  Always turn off hyphenation; it makes
.\" way too many mistakes in technical documents.
.if n .ad l
.nh
.SH "Interchange Worldpay Support"
.IX Header "Interchange Worldpay Support"
Vend::Payment::Worldpay \f(CW$Revision:\fR 1.0.2 $
.PP
http://kiwi.zolotek.net is the home page with the latest version.
.SH "This package is for the 'Worldpay' payment system."
.IX Header "This package is for the 'Worldpay' payment system."
.SH "Quick Start Summary"
.IX Header "Quick Start Summary"
1 Place this module in <IC_root>/lib/Vend/Payment/Worldpay.pm
.PP
2 Call it in interchange.cfg with:
    Require module Vend::Payment::Worldpay.
.PP
3 Add a new route into catalog.cfg (options for the last entry in parentheses):
  Route worldpay host https://secure.wp3.rbsworldpay.com/wcc/purchase (Live Payment \s-1URL\s0)
  Route worldpay testhost https://secure\-test.wp3.rbsworldpay.com/wcc/dispatcher (Test payment \s-1URL\s0)
  Route worldpay instid 12345 (Your Worldpay instID)
  Route worldpay currency \s-1GBP \s0(defaults to \s-1GBP\s0)
  Route worldpay testmode 100 (Set to 100 for test mode 0 for live \- default live)
  Route worldpay callbackurl (The \s-1URL\s0 Worldpay will callback eg www.yourstore.co.uk/cgi\-bin/yourname/wpcallback.html)
  Route worldpay callpw (Callback password, set any password you like and set it the same in the \s-1WP\s0 Admin Panel)
  Route worldpay fixcontact 1 (If set to 1 customers cannot ammend address details when they get to worldpay, 0 to allow changes)
  Route worldpay desc 'Yourstore Order' (Text to send in the desc field eg 'Yourstore Order')
  Route worldpay reporttitle 1 (If set to 1 will modifty order report title to include transaction \s-1ID\s0)
  Route worldpay update_status processing (Text to set order status on success eg processing, default pending)
  Route worldpay wpcounter (Defines the counter for temporary order number, defaults to etc/username)
  Route worldpay md5pw yourmd5secret (required in this version, will die without it)
.PP
## md5 code ##
  Enter the following into the worldpay control panel:\-
  Your \s-1MD5\s0 secret as set in catalog.cfg
  In the signature fields box enter amount:instId:MC_affsubtotal:currency
.PP
4 Create a new locale setting for en_GB as noted in \*(L"item currency\*(R" below, and copy the
public space interchange/en_US/ directory to a new interchange/en_GB/ one. Ensure that any
other locales you might use have a correctly named directory as well. Ensure that this locale
is found in your version of locale.txt (and set up \s-1GB\s0 as opposed to \s-1US\s0 language strings to taste).
.PP
5 Add a new order profile in etc/profiles.order
.PP
_\|_NAME_\|_                            worldpay
fname=required
b_fname=required
lname=required
b_lname=required
address1=required
b_address1=required
city=required
b_city=required
state=required
b_state=required
zip=required
b_zip=required
&fatal = yes
email=required
email=email
&set=mv_payment worldpay
&set=psp worldpay
&set=mv_payment_route worldpay
&set=mv_order_route worldpay
&final = yes
&setcheck = payment_method worldpay
_\|_END_\|_
.PP
6 Add the following fields to the transactions table if they do not already exist (run from a mysql prompt)
.PP
\&\s-1ALTER TABLE\s0 `transactions` \s-1ADD\s0 `wp_transtime` \s-1VARCHAR\s0( 64 ) \s-1CHARACTER SET\s0 utf8 \s-1COLLATE\s0 utf8_general_ci ,
\&\s-1ADD\s0 `wp_cardtype` \s-1VARCHAR\s0( 64 ) \s-1CHARACTER SET\s0 utf8 \s-1COLLATE\s0 utf8_general_ci,
\&\s-1ADD\s0 `wp_countrymatch` \s-1VARCHAR\s0( 64 ) \s-1CHARACTER SET\s0 utf8 \s-1COLLATE\s0 utf8_general_ci,
\&\s-1ADD\s0 `wp_avs` \s-1VARCHAR\s0( 64 ) \s-1CHARACTER SET\s0 utf8 \s-1COLLATE\s0 utf8_general_ci,
\&\s-1ADD\s0 `wp_risk` \s-1VARCHAR\s0( 64 ) \s-1CHARACTER SET\s0 utf8 \s-1COLLATE\s0 utf8_general_ci,
\&\s-1ADD\s0 `wp_authentication` \s-1VARCHAR\s0( 64 ) \s-1CHARACTER SET\s0 utf8 \s-1COLLATE\s0 utf8_general_ci,
\&\s-1ADD\s0 `wp_authamount` \s-1VARCHAR\s0( 64 ) \s-1CHARACTER SET\s0 utf8 \s-1COLLATE\s0 utf8_general_ci,
\&\s-1ADD\s0 `wp_order_number` \s-1VARCHAR\s0( 64 ) \s-1CHARACTER SET\s0 utf8 \s-1COLLATE\s0 utf8_general_ci,
\&\s-1ADD\s0 `wp_transtime` \s-1VARCHAR\s0( 64 ) \s-1CHARACTER SET\s0 utf8 \s-1COLLATE\s0 utf8_general_ci,
\&\s-1ADD\s0 `lead_source` \s-1VARCHAR\s0(255) \s-1CHARACTER SET\s0 utf8 \s-1COLLATE\s0 utf8_general_ci,
\&\s-1ADD\s0 `referring_url` \s-1VARCHAR\s0(255) \s-1CHARACTER SET\s0 utf8 \s-1COLLATE\s0 utf8_general_ci,
\&\s-1ADD\s0 `txtype` \s-1VARCHAR\s0(64) \s-1CHARACTER SET\s0 utf8 \s-1COLLATE\s0 utf8_general_ci,
\&\s-1ADD\s0 `email_copy` \s-1\fICHAR\s0\fR\|(1) \s-1CHARACTER SET\s0 utf8 \s-1COLLATE\s0 utf8_general_ci,
\&\s-1ADD\s0 `mail_list` varCHAR(255) \s-1CHARACTER SET\s0 utf8 \s-1COLLATE\s0 utf8_general_ci,
\&\s-1ADD\s0 `cartid` \s-1VARCHAR\s0(64) \s-1CHARACTER SET\s0 utf8 \s-1COLLATE\s0 utf8_general_ci,
\&\s-1ADD\s0 `cart` \s-1BLOB\s0;
.PP
And run these to allow for temporary order numbers of greater than the default 14 character field type
\&\s-1ALTER TABLE\s0 `transactions` \s-1MODIFY\s0 `order_number` varchar(32);
\&\s-1ALTER TABLE\s0 `orderline` \s-1MODIFY\s0 `order_number` varchar(32);
.PP
Also add 'cartid' to the orderline table.
.PP
7. Add the following to etc/log_transaction just \s-1BEFORE\s0 [/import][/try]
.PP
lead_source: [data session source]
referring_url: [data session referer]
cart: [calc]uneval($Items)[/calc]
cartid: [value mv_order_number]
email_copy: [value email_copy]
mail_list: [value mail_list]
.PP
8. Still in etc/log_transaction, find the section that starts \*(L"Set order number in values: \*(R" and insert
this just before it:
.PP
\&\s-1NB/\s0 this only applies if your \s-1IC\s0 is greater than v 5.2, otherwise skip sections 8 & 9
.PP
[if value mv_order_profile =~ /worldpay/]
[value name=mv_order_number set=\*(L"[scratch purchaseID]\*(R" scratch=1]
[else]
and a closing [/else][/if] at the end of that section, just before the 
\&\*(L"Set order number in session:\*(R"
line. The order number is generated by the module and passed to Worldpay at an early stage, and then
passed back to Interchange with a callback. This prevents Interchange generating another order number.
The module will not currently work with \s-1IC\s0 versions lower than 5.2 that use a tid counter defined in
catalog.cfg. The initial order number uses the username.counter number prefixed with 'WPtmp', and a normal
order number is created and the initial order number replaced only when Worldpay calls back that the card
has been charged. This is to avoid gaps in the order number sequence caused by customers abandoning the 
transaction.
.PP
9. In etc/log_transction, change the line:\- 
[elsif variable \s-1MV_PAYMENT_MODE\s0]
to
[elsif value mv_order_profile =~ /worldpay/] add an \s-1OR\s0 if required
eg [elsif value mv_order_profile =~ /googlecheckout|worldpay/]
.PP
Then in the [calc] block immediately below insert this line:
.PP
.Vb 1
\&        undef $Session\->{payment_result}{MStatus};
.Ve
.PP
Within the same section change the following two instances of
[var \s-1MV_PAYMENT_MODE\s0] to [value mv_payment_route]
.PP
10. Create a callback page in /pages called wpcallback.html or any name you prefer, set this page in
the Worldpay admin panel, the module also supports dynamic callback pages where different catalogs can
have different callback pages, if using this the callpage \s-1URL\s0 must be set in the route in catalog.cfg as
described above.
.PP
At the top of the callback page include the following line:\-
[charge route=\*(L"worldpay\*(R" worldpayrequest=\*(L"callback\*(R"]
.PP
At the end of the charge process Worldpay do not allow redirection to a receipt page, if you do this they
claim they will disable the callback feature or even suspend your account, how nice! You can however re-direct if
the transaction is cancelled
.PP
Worldpay will suck the wpcallback page back to their server and display it for you, this can be used to display a receipt page.
The page will interpolate before being sucked to Worldpay so most items such as fname lname adress fields etc are usuable on the page.
To display banners and logos they need to be pre-loaded onto the Worldpay server
.PP
At the top of the callback page just below the [charge route=\*(L"worldpay\*(R" worldpayrequest=\*(L"callback\*(R"] you can test for a successful transaction as follows:\-
.PP
[if type=\*(L"cgi\*(R" term=\*(L"transStatus\*(R" op=\*(L"eq\*(R" compare=\*(L"Y\*(R"] 
[and type=\*(L"cgi\*(R" term=\*(L"callbackPW\*(R" op=\*(L"eq\*(R" compare=\*(L"yourcallbackpassword\*(R"]
.PP
Display a receipt page
.PP
[else]
.PP
Display a cancelled page or bounce the customer back to site etc
.PP
[/else]
[/if]
.PP
11. Checkout button
.PP
On your checkout page include a button that sets the route and submits the checkout form eg
.PP
[button
    mv_click=worldpay
    text=\*(L"Place Order\*(R"
    hidetext=1
    form=checkout
   ]
   mv_order_profile=worldpay
   mv_order_route=log
   mv_todo=submit
[/button]
.PP
\&\s-1NB/\s0 for \s-1IC\s0 versions 5.2 and older, make the button so as to call the 'wprequest.html' page:
.PP
[button
    mv_click=worldpay
    text=\*(L"Place Order\*(R"
    hidetext=1
    form=checkout
   ]
   mv_nextpage=ord/wprequest
   mv_order_route=log
   mv_todo=submit
[/button]
.SH "PREREQUISITES"
.IX Header "PREREQUISITES"
.Vb 3
\&  Net::SSLeay
\&    or
\&  LWP::UserAgent and Crypt::SSLeay
\&
\&  wget \- a recent version built with SSL and supporting the \*(Aqconnect\*(Aq timeout function.
.Ve
.SH "DESCRIPTION"
.IX Header "DESCRIPTION"
The Vend::Payment::Worldpay module implements the \fIWorldpay()\fR routine for use with
Interchange. It is _not_ compatible on a call level with the other Interchange
payment modules.
.PP
To enable this module, place this directive in <interchange.cfg>:
.PP
.Vb 1
\&    Require module Vend::Payment::Worldpay
.Ve
.PP
This \fImust\fR be in interchange.cfg or a file included from it.
.PP
The module collects the data from a checkout form and formats it with a re-direct to
the Worldpay payment server. The customers details and cart is logged in the database
before going to Worldpay with a temporary order number of the form WPtmpUxxxx where Uxxxx
is derived from the username counter
.PP
If the transaction is successful the module processes the callback response from Worlday, if
successful the temporary order number is converted to an Interchange order number and a final
route is run to send out the report and customer emails. Cancelled transactions remain in the
database with the temporary order numbers but are automatically archived.
.PP
The module will also optionally decrement the inventory on a successful, if used
the inventory decrement in log transaction should be disabled by setting the appropriate variable
.SH "The active settings."
.IX Header "The active settings."
The module uses several of the standard settings from the Interchange payment routes.
Any such setting, as a general rule, is obtained first from the tag/call options on
a page, then from an Interchange order Route named for the mode in catalog.cfg,
then a default global payment variable in products/variable.txt, and finally in
some cases a default will be hard-coded into the module.
.IP "instid" 4
.IX Item "instid"
Your installation id supplied by Worldpay, the module cannot be used without an instid, set in
catalog.cfg
.IP "currency" 4
.IX Item "currency"
Worldpay requires that a currency code be sent, using the 3 letter \s-1ISO\s0 currency code standard,
eg, \s-1GBP, EUR, USD.\s0 The value is taken firstly from the route parameter in catalog.cfg and
defaults to \s-1GBP\s0
.IP "testmode" 4
.IX Item "testmode"
Sets whether the system runs test or live transactions, set to 0 (default) for live transactions, 
or 100 for test transactions.
.IP "callbackurl" 4
.IX Item "callbackurl"
If using dynamic callback pages with Worldpay, set you callback page without the http eg:\-
.Sp
www.yourstore.co.uk/cgi\-bin/yourstore/wpcallback.html
.IP "callpw" 4
.IX Item "callpw"
Sets the password to compare with the callback, set this the same as the password in the Worldpay
admin panel
.IP "desc" 4
.IX Item "desc"
Sets the text for the desc field sent to Worldpay and will appear on the transaction reciper, eg
\&'Yourstore Order'
.IP "fixcontact" 4
.IX Item "fixcontact"
Fixes the information send to Worldpay so it cannot be modified by the customer at Worldpay, set to 1
to fix or 0 to allow the customer to edit address at Worldpay.
.IP "reporttitle" 4
.IX Item "reporttitle"
Set to 1 to change the email report title to include the Worldpay transaction \s-1ID,\s0 set to zero for
standard report email title
.IP "update_status" 4
.IX Item "update_status"
Allows the order status to be set to any desired value after a successful transaction, eg set to processing
and all successfull transactions will have status processing, defaults to pending
.IP "dec_inventory" 4
.IX Item "dec_inventory"
Set to 1 for module to decrement the inventory on a successful transaction, if used disable decrement via
log_transaction.
.SS "Testing"
.IX Subsection "Testing"
Set testmode 100 in catalog.cfg
.PP
Add some items to the cart and place the order, the module will re-direct you
to Worldpay where you can select the card type to pay with. Enter some test card details and check
the order is logged in the database ok and emails sent out.
.PP
Test card numbers
.PP
Mastercard
5100080000000000
.PP
Visa Delta \- \s-1UK
4406080400000000\s0
.PP
Visa Delta \- Non \s-1UK
4462030000000000\s0
.PP
Visa
4911830000000
.PP
Visa
4917610000000000
.PP
American Express
370000200000000
.PP
Diners
36700102000000
.PP
\&\s-1JCB
3528000700000000\s0
.PP
Visa Electron (\s-1UK\s0 only)
4917300800000000
.PP
Solo
6334580500000000
.PP
Solo
633473060000000000
.PP
Discover Card
6011000400000000
.PP
Laser
630495060000000000
.PP
Maestro
6759649826438453
.PP
Visa Purchasing
4484070000000000
.SH "changelog \- v1.0.2 November 2011, added encryption from Andy to main request as defence against tampering \- v1.0.1 not released: October 2010, made work with IC v4.8.7 \- needs to have 'use strict' commented out, and a redirection page"
.IX Header "changelog - v1.0.2 November 2011, added encryption from Andy to main request as defence against tampering - v1.0.1 not released: October 2010, made work with IC v4.8.7 - needs to have 'use strict' commented out, and a redirection page"
.SH "AUTHORS"
.IX Header "AUTHORS"
Andy Smith <andy@tvcables.co.uk> with help from and based on code by
Lyn St George <lyn@zolotek.net>, which in turn was based on original
code by Mike Heins <mike@perusion.com> and others.
